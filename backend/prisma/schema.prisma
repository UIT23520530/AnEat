// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN_SYSTEM
  ADMIN_BRAND
  STAFF
  CUSTOMER
  LOGISTICS_STAFF
}

enum OrderStatus {
  PENDING
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

enum TableStatus {
  EMPTY
  OCCUPIED
  RESERVED
}

enum PromotionType {
  PERCENTAGE
  FIXED
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  E_WALLET
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum CustomerTier {
  BRONZE
  SILVER
  GOLD
  VIP
}

enum StockRequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum StockRequestType {
  RESTOCK
  ADJUSTMENT
  RETURN
}

enum BillStatus {
  DRAFT
  ISSUED
  PAID
  CANCELLED
  REFUNDED
}

enum TemplateCategory {
  INVOICE
  ORDER
  RECEIPT
  REPORT
}

enum TemplateStatus {
  ACTIVE
  INACTIVE
}

enum ShipmentStatus {
  READY        // Sẵn sàng giao
  IN_TRANSIT   // Đang vận chuyển
  DELIVERED    // Đã giao (chờ xác nhận)
  COMPLETED    // Hoàn thành
  CANCELLED    // Đã hủy
}

// ==================== MODELS ====================

model User {
  id       String   @id @default(cuid())
  email    String   @unique
  password String
  name     String
  phone    String
  role     UserRole @default(CUSTOMER)
  avatar   String?
  branchId String?
  branch   Branch?  @relation("staff", fields: [branchId], references: [id], onDelete: SetNull)

  // ✨ Cải thiện: Thêm trạng thái và tracking login
  isActive  Boolean   @default(true)
  lastLogin DateTime?

  managedBranches Branch?  @relation("manager")
  ordersAssigned  Order[]
  
  requestedStockRequests StockRequest[] @relation("requestedStockRequests")
  approvedStockRequests  StockRequest[] @relation("approvedStockRequests")
  stockTransactions      StockTransaction[] @relation("performedStockTransactions")
  assignedShipments      Shipment[] @relation("assignedShipments")
  
  issuedBills         Bill[]        @relation("issuedBills")
  editedBillHistories BillHistory[] @relation("editedBillHistories")
  createdTemplates    Template[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime? // Soft delete support

  @@map("User")
}

model Branch {
  id        String  @id @default(cuid())
  code      String  @unique
  name      String
  address   String
  phone     String
  email     String?
  managerId String? @unique
  manager   User?   @relation("manager", fields: [managerId], references: [id], onDelete: SetNull)
  stockRequests     StockRequest[]
  stockTransactions StockTransaction[]
  shipments         Shipment[]
  bills             Bill[]
  templates         Template[]
  
  staff     User[]    @relation("staff")
  products  Product[]
  tables    Table[]
  orders    Order[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("Branch")
}

// ✨ NEW: Danh mục sản phẩm
model ProductCategory {
  id          String    @id @default(cuid())
  code        String    @unique
  name        String
  description String?
  image       String?
  isActive    Boolean   @default(true)

  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("ProductCategory")
}

model Product {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  price       Int // Lưu theo cent (1000 = 10k)
  image       String?
  branchId    String
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  // ✨ Cải thiện: Thêm hàng tồn kho, thời gian chuẩn bị, giá vốn
  quantity     Int     @default(0) // Số lượng tồn kho
  costPrice    Int     @default(0) // Giá vốn (tính theo cent)
  prepTime     Int     @default(15) // Thời gian chuẩn bị (phút)
  stockRequests     StockRequest[]
  stockTransactions StockTransaction[]
  
  isAvailable  Boolean @default(true)

  // ✨ Cải thiện: Thêm danh mục sản phẩm
  categoryId String?
  category   ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  orderItems OrderItem[]
  inventory  Inventory?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@map("Product")
}

// ✨ NEW: Theo dõi hàng tồn kho (Inventory)
model Inventory {
  id        String   @id @default(cuid())
  productId String   @unique
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity      Int
  lastRestocked DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("Inventory")
}

model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique
  total       Int // Tổng tiền (tính theo cent)
  status      OrderStatus @default(PENDING)
  notes       String?

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  staffId String?
  staff   User?   @relation(fields: [staffId], references: [id], onDelete: SetNull)

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  items       OrderItem[]
  promotion   Promotion?  @relation(fields: [promotionId], references: [id], onDelete: SetNull)
  promotionId String?

  // ✨ Cải thiện: Thêm thông tin thanh toán
  paymentMethod PaymentMethod?
  paymentStatus PaymentStatus @default(PENDING)

  
  stockTransactions StockTransaction[]
  // ✨ Cải thiện: Thêm thông tin giao hàng
  deliveryAddress String?
  deliveryDate    DateTime?

  // ✨ Cải thiện: Thêm trường discount để báo cáo
  discountAmount Int @default(0)
  
  // Relation với Bill
  bill Bill?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  @@map("Order")
}

model OrderItem {
  id       String @id @default(cuid())
  quantity Int
  price    Int // Giá tại thời điểm đặt hàng

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())

  @@map("OrderItem")
}

model Customer {
  id     String  @id @default(cuid())
  phone  String  @unique
  name   String
  email  String? @unique
  avatar String?

  // ✨ Cải thiện: Thêm chương trình loyalty
  tier       CustomerTier @default(BRONZE)
  totalSpent Int          @default(0) // Tổng chi tiêu (tính theo cent)
  points     Int          @default(0) // Điểm thưởng

  orders        Order[]
  lastOrderDate DateTime?

  reviews   Review[] @relation("customerReviews")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Customer")
}

model Table {
  id     String      @id @default(cuid())
  code   String
  status TableStatus @default(EMPTY)
  seats  Int

  // ✨ Cải thiện: Thêm khu vực bàn
  section String? // e.g., "PATIO", "INDOOR", "VIP"

  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, code])
  @@map("Table")
}

model Promotion {
  id        String        @id @default(cuid())
  code      String        @unique
  type      PromotionType
  value     Int // Giá trị giảm giá hoặc phần trăm
  maxUses   Int?
  usedCount Int           @default(0)
  isActive  Boolean       @default(true)

  // ✨ Cải thiện: Thêm ngày hết hạn và điều kiện tối thiểu
  expiryDate       DateTime?
  minOrderAmount   Int?
  applicableProducts String? // JSON array của product IDs hoặc null nếu áp dụng cho tất cả

  orders    Order[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Promotion")
}

// ✨ NEW: Bảng Review/Rating cho sản phẩm
model Review {
  id        String   @id @default(cuid())
  productId String

  customerId String
  customer   Customer @relation("customerReviews", fields: [customerId], references: [id], onDelete: Cascade)

  rating  Int // 1-5
  comment String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Review")
}

// ✨ NEW: Bảng lịch sử thanh toán chi tiết
model PaymentTransaction {
  id        String   @id @default(cuid())
  orderId   String
  // order     Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)

  amount        Int
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String? // ID từ payment gateway
  errorMessage  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("PaymentTransaction")
}

// ✨ NEW: Bảng yêu cầu nhập kho
model StockRequest {
  id             String             @id @default(cuid())
  requestNumber  String             @unique
  type           StockRequestType   @default(RESTOCK)
  status         StockRequestStatus @default(PENDING)
  
  requestedQuantity Int
  approvedQuantity  Int?
  notes             String?
  
  requestedDate DateTime? // Thời gian yêu cầu nhập
  expectedDate  DateTime? // Thời gian dự kiến giao hàng
  completedDate DateTime? // Thời gian hoàn thành
  rejectedReason String?
  
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)
  
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  requestedById String
  requestedBy   User   @relation("requestedStockRequests", fields: [requestedById], references: [id], onDelete: Restrict)
  
  approvedById String?
  approvedBy   User?   @relation("approvedStockRequests", fields: [approvedById], references: [id], onDelete: SetNull)
  
  transactions StockTransaction[]
  shipments    Shipment[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("StockRequest")
}

// ✨ NEW: Bảng lịch sử giao dịch kho
model StockTransaction {
  id                String  @id @default(cuid())
  transactionNumber String  @unique
  type              String  // 'STOCK_IN', 'STOCK_OUT', 'ADJUSTMENT', 'ORDER_COMPLETED', 'DELIVERY_CONFIRMED'
  quantity          Int     // Số lượng thay đổi (dương = tăng, âm = giảm)
  previousQuantity  Int     // Số lượng trước khi thay đổi
  newQuantity       Int     // Số lượng sau khi thay đổi
  reason            String?
  reference         String? // Mã tham chiếu (order number, request number, etc.)
  
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)
  
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  performedById String
  performedBy   User   @relation("performedStockTransactions", fields: [performedById], references: [id], onDelete: Restrict)
  
  stockRequestId String?
  stockRequest   StockRequest? @relation(fields: [stockRequestId], references: [id], onDelete: SetNull)
  
  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())

  @@map("StockTransaction")
}

// ✨ NEW: Bảng hoá đơn (Bill/Invoice)
model Bill {
  id          String     @id @default(cuid())
  billNumber  String     @unique // Mã hoá đơn
  status      BillStatus @default(ISSUED)
  
  // Thông tin hoá đơn
  subtotal    Int        // Tổng tiền trước thuế và giảm giá
  taxAmount   Int        @default(0) // Thuế VAT
  discountAmount Int     @default(0) // Số tiền giảm giá
  total       Int        // Tổng tiền cuối cùng
  
  // Thông tin khách hàng
  customerName    String?
  customerPhone   String?
  customerEmail   String?
  customerAddress String?
  
  // Thông tin thanh toán
  paymentMethod   PaymentMethod?
  paymentStatus   PaymentStatus @default(PENDING)
  paidAmount      Int           @default(0)
  changeAmount    Int           @default(0)
  
  // Thông tin bổ sung
  notes           String?
  internalNotes   String? // Ghi chú nội bộ (không in ra bill)
  
  // Relations
  orderId  String  @unique
  order    Order   @relation(fields: [orderId], references: [id], onDelete: Restrict)
  
  branchId String
  branch   Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  issuedById String
  issuedBy   User   @relation("issuedBills", fields: [issuedById], references: [id], onDelete: Restrict)
  
  // Lịch sử chỉnh sửa
  histories  BillHistory[]
  
  // Tracking
  isEdited    Boolean   @default(false)
  editCount   Int       @default(0)
  lastEditedAt DateTime?
  
  printedCount Int      @default(0)
  lastPrintedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("Bill")
}

// ✨ NEW: Bảng lịch sử chỉnh sửa hoá đơn
model BillHistory {
  id          String   @id @default(cuid())
  version     Int      // Phiên bản (1, 2, 3...)
  
  // Snapshot của hoá đơn tại thời điểm chỉnh sửa
  billNumber  String
  status      BillStatus
  
  subtotal       Int
  taxAmount      Int
  discountAmount Int
  total          Int
  
  customerName    String?
  customerPhone   String?
  customerEmail   String?
  customerAddress String?
  
  paymentMethod   PaymentMethod?
  paymentStatus   PaymentStatus
  paidAmount      Int
  changeAmount    Int
  
  notes          String?
  internalNotes  String?
  
  // Lý do chỉnh sửa
  editReason     String // Lý do chỉnh sửa (bắt buộc)
  changedFields  String // JSON array của các trường đã thay đổi
  
  // Relations
  billId String
  bill   Bill   @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  editedById String
  editedBy   User   @relation("editedBillHistories", fields: [editedById], references: [id], onDelete: Restrict)
  
  createdAt DateTime @default(now())

  @@map("BillHistory")
}

// ✨ NEW: Template model for invoice/order/receipt templates
model Template {
  id          String           @id @default(cuid())
  name        String
  type        String           // e.g., "Mẫu hóa đơn", "Mẫu đơn hàng"
  description String?
  content     String           // HTML template with placeholders
  category    TemplateCategory // INVOICE, ORDER, RECEIPT, REPORT
  status      TemplateStatus   @default(ACTIVE)
  isDefault   Boolean          @default(false)
  
  // Branch relation (null means company-wide template)
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id], onDelete: SetNull)
  
  // Creator tracking
  createdBy String?
  creator   User?   @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  @@map("Template")
}

// ✨ NEW: Shipment model for logistics staff
model Shipment {
  id             String         @id @default(cuid())
  shipmentNumber String         @unique // Mã chuyến hàng NL001, NL002...
  status         ShipmentStatus @default(READY)
  priority       Boolean        @default(false) // Ưu tiên cao
  
  // Thông tin hàng hóa
  productName    String // Tên món hàng
  quantity       Int    // Số lượng
  temperature    String? // Nhiệt độ bảo quản (2-4°C, 4-8°C...)
  
  // Thông tin điểm đi - điểm đến
  fromLocation   String // Kho Trung Tâm
  toLocation     String // Chi nhánh Quận 1
  branchCode     String // CN-Q1-01
  
  // Thời gian
  assignedAt     DateTime? // Thời gian phân công
  startedAt      DateTime? // Thời gian bắt đầu
  deliveredAt    DateTime? // Thời gian giao hàng
  completedAt    DateTime? // Thời gian hoàn thành
  
  notes          String?
  issues         Int      @default(0) // Số vấn đề
  
  // Relations
  stockRequestId String?
  stockRequest   StockRequest? @relation(fields: [stockRequestId], references: [id], onDelete: SetNull)
  
  assignedToId   String? // Logistics Staff được phân công
  assignedTo     User?   @relation("assignedShipments", fields: [assignedToId], references: [id], onDelete: SetNull)
  
  branchId       String
  branch         Branch  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("Shipment")
}

