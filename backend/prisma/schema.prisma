generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String             @id @default(cuid())
  email                  String             @unique
  password               String
  name                   String
  phone                  String
  role                   UserRole           @default(CUSTOMER)
  avatar                 String?
  branchId               String?
  isActive               Boolean            @default(true)
  lastLogin              DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  deletedAt              DateTime?
  issuedBills            Bill[]             @relation("issuedBills")
  editedBillHistories    BillHistory[]      @relation("editedBillHistories")
  managedBranches        Branch?            @relation("manager")
  ordersAssigned         Order[]
  assignedShipments      Shipment[]         @relation("assignedShipments")
  approvedStockRequests  StockRequest[]     @relation("approvedStockRequests")
  requestedStockRequests StockRequest[]     @relation("requestedStockRequests")
  stockTransactions      StockTransaction[] @relation("performedStockTransactions")
  createdTemplates       Template[]
  branch                 Branch?            @relation("staff", fields: [branchId], references: [id])

  @@map("User")
}

model Branch {
  id                String             @id @default(cuid())
  code              String             @unique
  name              String
  address           String
  phone             String
  email             String?
  managerId         String?            @unique
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  deletedAt         DateTime?
  bills             Bill[]
  manager           User?              @relation("manager", fields: [managerId], references: [id])
  orders            Order[]
  products          Product[]
  shipments         Shipment[]
  stockRequests     StockRequest[]
  stockTransactions StockTransaction[]
  tables            Table[]
  templates         Template[]
  staff             User[]             @relation("staff")
  promotions        Promotion[]

  @@map("Branch")
}

model ProductCategory {
  id          String    @id @default(cuid())
  code        String    @unique
  name        String
  description String?
  image       String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@map("ProductCategory")
}

model Product {
  id                String             @id @default(cuid())
  code              String             @unique
  name              String
  description       String?
  price             Int
  image             String?
  branchId          String
  quantity          Int                @default(0)
  costPrice         Int                @default(0)
  prepTime          Int                @default(15)
  isAvailable       Boolean            @default(true)
  categoryId        String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  deletedAt         DateTime?
  inventory         Inventory?
  orderItems        OrderItem[]
  branch            Branch             @relation(fields: [branchId], references: [id], onDelete: Cascade)
  category          ProductCategory?   @relation(fields: [categoryId], references: [id])
  options           ProductOption[]
  stockRequests     StockRequest[]
  stockTransactions StockTransaction[]

  @@map("Product")
}

model ProductOption {
  id               String            @id @default(cuid())
  productId        String
  name             String
  description      String?
  price            Int               @default(0)
  type             String            @default("OTHER")
  isRequired       Boolean           @default(false)
  isAvailable      Boolean           @default(true)
  order            Int               @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  orderItemOptions OrderItemOption[]
  product          Product           @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("ProductOption")
}

model Inventory {
  id            String    @id @default(cuid())
  productId     String    @unique
  quantity      Int
  lastRestocked DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("Inventory")
}

model Order {
  id                String             @id @default(cuid())
  orderNumber       String             @unique
  total             Int
  status            OrderStatus        @default(PENDING)
  notes             String?
  customerId        String?
  staffId           String?
  branchId          String
  promotionId       String?
  paymentMethod     PaymentMethod?
  paymentStatus     PaymentStatus      @default(PENDING)
  orderType         OrderType          @default(DELIVERY)
  deliveryAddress   String?
  deliveryPhone     String?
  deliveryDate      DateTime?
  discountAmount    Int                @default(0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  completedAt       DateTime?
  bill              Bill?
  branch            Branch             @relation(fields: [branchId], references: [id], onDelete: Cascade)
  customer          Customer?          @relation(fields: [customerId], references: [id])
  promotion         Promotion?         @relation(fields: [promotionId], references: [id])
  staff             User?              @relation(fields: [staffId], references: [id])
  items             OrderItem[]
  stockTransactions StockTransaction[]

  @@map("Order")
}

model OrderItem {
  id        String            @id @default(cuid())
  quantity  Int
  price     Int
  orderId   String
  productId String
  createdAt DateTime          @default(now())
  notes     String?
  order     Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product           @relation(fields: [productId], references: [id])
  options   OrderItemOption[]

  @@map("OrderItem")
}

model OrderItemOption {
  id          String        @id @default(cuid())
  orderItemId String
  optionId    String
  optionName  String
  optionPrice Int
  createdAt   DateTime      @default(now())
  option      ProductOption @relation(fields: [optionId], references: [id])
  orderItem   OrderItem     @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@map("OrderItemOption")
}

model Customer {
  id            String       @id @default(cuid())
  phone         String       @unique
  name          String
  email         String?      @unique
  avatar        String?
  tier          CustomerTier @default(BRONZE)
  totalSpent    Int          @default(0)
  points        Int          @default(0)
  lastOrderDate DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?
  orders        Order[]
  reviews       Review[]     @relation("customerReviews")

  @@map("Customer")
}

model Table {
  id        String      @id @default(cuid())
  code      String
  status    TableStatus @default(EMPTY)
  seats     Int
  section   String?
  branchId  String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  branch    Branch      @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([branchId, code])
  @@map("Table")
}

model Promotion {
  id                 String        @id @default(cuid())
  code               String
  type               PromotionType
  value              Int
  maxUses            Int?
  usedCount          Int           @default(0)
  isActive           Boolean       @default(true)
  expiryDate         DateTime?
  minOrderAmount     Int?
  applicableProducts String?
  branchId           String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  branch             Branch?       @relation(fields: [branchId], references: [id])
  orders             Order[]

  @@unique([code, branchId])
  @@map("Promotion")
}

model Review {
  id         String   @id @default(cuid())
  productId  String
  customerId String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  customer   Customer @relation("customerReviews", fields: [customerId], references: [id], onDelete: Cascade)

  @@map("Review")
}

model PaymentTransaction {
  id            String        @id @default(cuid())
  orderId       String
  amount        Int
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?
  errorMessage  String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("PaymentTransaction")
}

model StockRequest {
  id                String             @id @default(cuid())
  requestNumber     String             @unique
  type              StockRequestType   @default(RESTOCK)
  status            StockRequestStatus @default(PENDING)
  requestedQuantity Int
  approvedQuantity  Int?
  notes             String?
  requestedDate     DateTime?
  expectedDate      DateTime?
  completedDate     DateTime?
  rejectedReason    String?
  productId         String
  branchId          String
  requestedById     String
  approvedById      String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  shipments         Shipment[]
  approvedBy        User?              @relation("approvedStockRequests", fields: [approvedById], references: [id])
  branch            Branch             @relation(fields: [branchId], references: [id], onDelete: Cascade)
  product           Product            @relation(fields: [productId], references: [id])
  requestedBy       User               @relation("requestedStockRequests", fields: [requestedById], references: [id])
  transactions      StockTransaction[]

  @@map("StockRequest")
}

model StockTransaction {
  id                String        @id @default(cuid())
  transactionNumber String        @unique
  type              String
  quantity          Int
  previousQuantity  Int
  newQuantity       Int
  reason            String?
  reference         String?
  productId         String
  branchId          String
  performedById     String
  stockRequestId    String?
  orderId           String?
  createdAt         DateTime      @default(now())
  branch            Branch        @relation(fields: [branchId], references: [id], onDelete: Cascade)
  order             Order?        @relation(fields: [orderId], references: [id])
  performedBy       User          @relation("performedStockTransactions", fields: [performedById], references: [id])
  product           Product       @relation(fields: [productId], references: [id])
  stockRequest      StockRequest? @relation(fields: [stockRequestId], references: [id])

  @@map("StockTransaction")
}

model Bill {
  id              String         @id @default(cuid())
  billNumber      String         @unique
  status          BillStatus     @default(ISSUED)
  subtotal        Int
  taxAmount       Int            @default(0)
  discountAmount  Int            @default(0)
  total           Int
  customerName    String?
  customerPhone   String?
  customerEmail   String?
  customerAddress String?
  paymentMethod   PaymentMethod?
  paymentStatus   PaymentStatus  @default(PENDING)
  paidAmount      Int            @default(0)
  changeAmount    Int            @default(0)
  notes           String?
  internalNotes   String?
  orderId         String         @unique
  branchId        String
  issuedById      String
  isEdited        Boolean        @default(false)
  editCount       Int            @default(0)
  lastEditedAt    DateTime?
  printedCount    Int            @default(0)
  lastPrintedAt   DateTime?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  branch          Branch         @relation(fields: [branchId], references: [id], onDelete: Cascade)
  issuedBy        User           @relation("issuedBills", fields: [issuedById], references: [id])
  order           Order          @relation(fields: [orderId], references: [id])
  histories       BillHistory[]

  @@map("Bill")
}

model BillHistory {
  id              String         @id @default(cuid())
  version         Int
  billNumber      String
  status          BillStatus
  subtotal        Int
  taxAmount       Int
  discountAmount  Int
  total           Int
  customerName    String?
  customerPhone   String?
  customerEmail   String?
  customerAddress String?
  paymentMethod   PaymentMethod?
  paymentStatus   PaymentStatus
  paidAmount      Int
  changeAmount    Int
  notes           String?
  internalNotes   String?
  editReason      String
  changedFields   String
  billId          String
  editedById      String
  createdAt       DateTime       @default(now())
  bill            Bill           @relation(fields: [billId], references: [id], onDelete: Cascade)
  editedBy        User           @relation("editedBillHistories", fields: [editedById], references: [id])

  @@map("BillHistory")
}

model Template {
  id          String           @id @default(cuid())
  name        String
  type        String
  description String?
  content     String
  category    TemplateCategory
  status      TemplateStatus   @default(ACTIVE)
  isDefault   Boolean          @default(false)
  branchId    String?
  createdBy   String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  deletedAt   DateTime?
  branch      Branch?          @relation(fields: [branchId], references: [id])
  creator     User?            @relation(fields: [createdBy], references: [id])

  @@map("Template")
}

model Shipment {
  id             String         @id @default(cuid())
  shipmentNumber String         @unique
  status         ShipmentStatus @default(READY)
  priority       Boolean        @default(false)
  productName    String
  quantity       Int
  temperature    String?
  fromLocation   String
  toLocation     String
  branchCode     String
  assignedAt     DateTime?
  startedAt      DateTime?
  deliveredAt    DateTime?
  completedAt    DateTime?
  notes          String?
  issues         Int            @default(0)
  stockRequestId String?
  assignedToId   String?
  branchId       String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  assignedTo     User?          @relation("assignedShipments", fields: [assignedToId], references: [id])
  branch         Branch         @relation(fields: [branchId], references: [id], onDelete: Cascade)
  stockRequest   StockRequest?  @relation(fields: [stockRequestId], references: [id])

  @@map("Shipment")
}

model Banner {
  id          String       @id @default(cuid())
  title       String?
  description String?
  image       String
  link        String?
  order       Int          @default(0)
  status      BannerStatus @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("Banner")
}

model AboutUs {
  id        String   @id @default(cuid())
  title     String
  content   String
  image     String?
  mission   String?
  vision    String?
  values    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("AboutUs")
}

enum UserRole {
  ADMIN_SYSTEM
  ADMIN_BRAND
  STAFF
  CUSTOMER
  LOGISTICS_STAFF
}

enum OrderStatus {
  PENDING
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

enum TableStatus {
  EMPTY
  OCCUPIED
  RESERVED
}

enum PromotionType {
  PERCENTAGE
  FIXED
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  E_WALLET
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum CustomerTier {
  BRONZE
  SILVER
  GOLD
  VIP
}

enum StockRequestStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
  CANCELLED
}

enum StockRequestType {
  RESTOCK
  ADJUSTMENT
  RETURN
}

enum BillStatus {
  DRAFT
  ISSUED
  PAID
  CANCELLED
  REFUNDED
}

enum TemplateCategory {
  INVOICE
  ORDER
  RECEIPT
  REPORT
}

enum TemplateStatus {
  ACTIVE
  INACTIVE
}

enum ShipmentStatus {
  READY
  IN_TRANSIT
  DELIVERED
  COMPLETED
  CANCELLED
}

enum BannerStatus {
  ACTIVE
  INACTIVE
}

enum OrderType {
  DELIVERY
  PICKUP
  DINE_IN
}
